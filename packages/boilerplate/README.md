# boilerplate

Example repo on how to use
[@jacco-meijer/wheelroom](https://www.npmjs.com/package/@jacco-meijer/wheelroom)
and
[gatsby-theme-wheelroom](https://www.npmjs.com/package/gatsby-theme-wheelroom)

## Getting started

### Required

This has been developed and tested on macOS. Ubuntu should not give any
problems. Windows has never been tried, there's possibly some unresolved path
issues there. I'd be happy to know.

The boilerplate depends on [nodeJS](https://nodejs.org) and uses
[Typescript](https://www.typescriptlang.org).

### Clone boilerplate

Copy the boilerplate code into a new folder and open a terminal in that folder.

You can use the commands below. Create an empty repository at Github and replace
`YOUR_GIT_URL_HERE` below with the url of this empty repository.

```bash
git clone --depth 1 git@github.com:jaccomeijer/wheelroom.git your-site
cd your-site
git filter-branch --prune-empty --subdirectory-filter packages/boilerplate master
git remote set-url origin YOUR_GIT_URL_HERE
git push -u origin master
```

### Install node modules

```bash
npm install
```

### Setup Contentful tokens

Create a new `.env` by copying the template

```bash
cp .env-template .env
```

The `CONTENTFUL_SPACE_ID` and `CONTENTFUL_DELIVERY_TOKEN` are found within the
Contentful web ui at `Settings -> API keys`. To obtain the
`CONTENTFUL_CMA_TOKEN`, you need to install the Contentful cli:

```bash
npm install -g contentful-cli
```

```bash
contentful login
```

You don't have to paste the token back in the terminal. Just having it in `.env`
is enough.


### Default locale for Contentful

Set the `defaultLocale` option in:

- [gatsby-config.js](gatsby-config.js) for the `gatsby-theme-wheelroom` plugin
- [src/config/wheelroom/config-plugin-options.ts](./src/config/wheelroom/config-plugin-options.ts) for the
  `@jacco-meijer/wheelroom-plugin-contentful` plugin


### Compile wheelroom config

Compile the config from typescript to javascript:

```bash
npm run compile-config
```

This runs: `tsc --project src/config/tsconfig.json`. It runs the
typescript compiler with the settings in `src/config/tsconfig.ts`.


### Test config by listing all components

Wheelroom can now list the available models configured in [config-components.ts](./src/config/wheelroom/config-components.ts):

```bash
npm run wr:ls
```

This runs: `WHEELROOM_CONFIG=compiled-config/wheelroom-config.js wheelroom list`.
It sets the environment variable `WHEELROOM_CONFIG` to use the config we
just compiled.


### Create Contentul models

Create the configured models in your Contentful space and check the Contentful
web ui.

```bash
npm run wr:cm
```

This runs: `WHEELROOM_CONFIG=compiled-config/wheelroom-config.js wheelroom create-models`.
It sets the config and runs the `create-models` command added by
[wheelroom-plugin-contentful](https://www.npmjs.com/package/@jacco-meijer/wheelroom-plugin-contentful).


### Create Contentful content set

Create a dummy image asset and the boilerplate content set found in
[content-sets.ts](./src/config/plugin-contentful/content-sets.ts). You need to run it twice
because on the first run some references have not yet been created. To prevent
this, a future version should learn how to handle circular references. A page
has an opener, an opener has navigation and navigation has pages.

```bash
npm run wr:cc
```

This runs: `WHEELROOM_CONFIG=compiled-config/wheelroom-config.js wheelroom create-content`.
It sets the config and runs the `create-content` command added by
[wheelroom-plugin-contentful](https://www.npmjs.com/package/@jacco-meijer/wheelroom-plugin-contentful).


### Create Graphql fragments and queries

The boilerplate contains all fragments and queries for the supplied config in [config-components.ts](./src/config/wheelroom/config-components.ts).

These files were generated by the command below. Running this again overwrites
the files but should not make any changes. See below on how to use a filter.

```bash
# Don't do this
npm run wr:cg
```

This runs: `WHEELROOM_CONFIG=compiled-config/wheelroom-config.js wheelroom create-graphql gatsbyjs src/components`.
It sets the config and runs the `create-graphql` command added by
[wheelroom-plugin-graphql](https://www.npmjs.com/package/@jacco-meijer//wheelroom-plugin-graphql).
The `gatsbyjs` template set is written to `src/components`.

Later on, when adding new components to
[config-components.ts](./src/config/wheelroom/config-components.ts), generate
only the new graphql by using a filter:

```bash
npm run compile-config
npm run wr:cg -- --filter newComponent
```


### Create React boilerplate code

The boilerplate contains a full demo site for the supplied config in [config-components.ts](./src/config/wheelroom/config-components.ts).

Running this command will overwrite the demo site, and sets up all components as
new components without layout. See below on how to use a filter.

```bash
# Don't do this
npm run wr:cb
```

This runs: `WHEELROOM_CONFIG=compiled-config/wheelroom-config.js wheelroom create-boilerplate react src/components`.
It sets the config and runs the `create-boilerplate` command added by
[wheelroom-plugin-boilerplate](https://www.npmjs.com/package/@jacco-meijer/wheelroom-plugin-boilerplate).
The `react` template set is written to `src/components`.

Later on, when adding new components to
[config-components.ts](./src/config/wheelroom/config-components.ts), generate
only boilerplate files for the component by using a filter:

```bash
npm run compile-config
npm run wr:cb -- --filter newComponent
```


### Fix linting errors

Fix boilerplate imports not ordered properly:

```bash
npm run lint-fix
```

This runs: `eslint 'src/**/*.{js,ts,tsx}' --fix`.

### Sections

The generated react code for the sections is used in [src/sections/sections.tsx](./src/sections/sections.tsx).

### Start development server

Start Gatsby by

```bash
npm run develop
```

Open http://localhost:8000

### Styled system

The templates use a style system: [@jacco-meijer/styled-system](https://www.npmjs.com/package/@jacco-meijer/styled-system). It's a simple typescript rewrite of [styled-system.com](https://styled-system.com) and makes it fully configurable. Styled system itself is based on [System UI Theme Specification](https://system-ui.com/theme/).

The config file can be found here: [./src/styled-system/styled-system-config.ts](./src/styled-system/styled-system-config.ts). To configure the theme, look here: [./src/styled-system/styled-system-theme.ts](./src/styled-system/styled-system-theme.ts)


### Page template

You can now edit [src/page-template.tsx](src/page-template.tsx). E.g. add
`console.log(props)` to the `PageTemplate` and inspect the `pageContext` prop.
It contains the `pageId` key used in the query in [src/page-template.tsx](src/page-template.tsx):

```graphql
  query($pageId: String, $globalsId: String) {
    site {
      siteMetadata {
        siteVersion
      }
    }
    page: contentfulPage(id: { eq: $pageId }) {
      ...Page
    }
    globals: contentfulGlobals(id: { eq: $globalsId }) {
      ...Globals
    }
  }
```

## How it works

The commands above read the compiled version of
[src/config/wheelroom-config.ts](./src/config/wheelroom-config.ts). The
components defined here are used to:

- create content models at Contentful
- create demo content entries at Contentful
- create Graphql fragments
- create Graphql queries
- create React boilerplate code

When the Gatsby development server starts, this is what happens:

- The queries defined in [gatsby-config.js](gatsby-config.js) are fetched by
  [gatsby-theme-wheelroom](https://www.npmjs.com/package/gatsby-theme-wheelroom)
- The theme is configured to use the generated Graphql queries:
  ```javascript
  const globalsQuery = require('./src/components/globals/query')
  const pageQuery = require('./src/components/page/query')
  ```
- Gatsby scans the `src` folder to build a Graphql node. It uses the generated Graphql in the
  `src/components` folder. Like this file:
  [src/components/opener-section/fragment.js](./src/components/opener-section/fragment.js)
- The `gatsby-theme-wheelroom` plugin uses the
  [src/page-template.tsx](src/page-template.tsx) to create pages for each path.
  The plugin gets the path from the entries returned by the page query. Page
  queries have `type: 'page'` defined. The entries returned by a page query must
  have a `path` attribute. The `pathName` attribute is used to build named
  paths. Named paths are useful for site localization.
- When all pages are created the `page-template.tsx` runs and loads all sections
  for the page by looking for available sections in
  [src/sections/sections.tsx](./src/sections/sections.tsx).

